{"pageProps":{"id":"use-github-actions-and-cloudflare-pages-improve-blog-online-process","title":"使用Github Actions与CloudFlare Pages优化博客上线流程","date":"2023-02-14","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    a: \"a\",\n    ol: \"ol\",\n    li: \"li\",\n    code: \"code\",\n    strong: \"strong\",\n    img: \"img\",\n    h2: \"h2\",\n    pre: \"pre\",\n    span: \"span\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.p, {\n      children: [\"在之前的文章\", _jsx(_components.a, {\n        href: \"https://b-sirius.github.io/posts/use-nextjs-create-SSG-blog\",\n        children: \"你的静态博客，何必是hexo\"\n      }), \"中，我大概介绍了如何搭建一个个人静态博客，但并没有涉及要如何将其上线。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我个人的首选方案是Github Pages，因为它免费，且域名直观。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在最初的时候，要发布一篇新的博客（或者做一些功能更新），我要手动做以下几步工作：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"在博客仓库（\", _jsx(_components.code, {\n          children: \"<username>.github.io\"\n        }), \"）切出一个本地新分支；\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"在分支上完成博客内容的编写；\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"本地运行\", _jsx(_components.code, {\n          children: \"yarn export\"\n        }), \"构建，生成\", _jsx(_components.code, {\n          children: \"/docs\"\n        }), \"目录（github pages只允许指定目录为根目录或docs目录）；\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"将更新过的代码推上远端分支；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"发起PR；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"合并PR；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"等待Github Pages重新部署，去线上验证博客是否更新成功；\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在多次不断的重复以上操作后，我意识到了几个问题：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"我经常忘记本地export构建，因为启动dev环境是不需要这一步的；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"博客仓库同时包含了源代码与构建产物代码，如果fork&clone的话，构建产物代码其实是完全没有用的；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"我只有在合并了main分支后才能验证线上博客是否更新成功。如果发生了本地环境没有出现的问题，那就意味着我的线上生产环境崩掉了；\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这种情形下，引入一些CI/CD工具实现\", _jsx(_components.strong, {\n        children: \"自动触发\"\n      }), \"的\", _jsx(_components.strong, {\n        children: \"线上构建部署\"\n      }), \"是常见的解决方案。我将会介绍\", _jsx(_components.strong, {\n        children: \"Github Actions\"\n      }), \"以及\", _jsx(_components.strong, {\n        children: \"CloudFlare Pages\"\n      }), \"，看看这两个免费服务可以帮我们实现怎样的自动化。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"【剧透】最终实现如下：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/02/14/iljSW7nucVfgAF1.png\",\n        alt: \"优化博客部署.png\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"github-actions\",\n      children: \"Github Actions\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"介绍它的文章很多，因此我不打算展开。直接说它的特点：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"它可以被各种各样的Github操作自动触发——比如新建分支、open PR、push到某个分支，也支持通过Github API手动触发（\", _jsx(_components.code, {\n          children: \"workflow_dispatch\"\n        }), \"）\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Github维护了一个Action市场，开发者可以使用社区贡献的Action而无需自己重新手写各种常用功能。比如获取当前的分支、指定node版本、将指定目录推送到Amazon S3。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"以我将博客推送到Github Pages的workflow为例：\"\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-yaml\",\n      children: _jsxs(_components.code, {\n        className: \"language-yaml\",\n        children: [_jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# .github/workflows/production.yml\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 所有的workflow必须放在.github/workflows目录下才能被识别，文件名会作为该workflow的名称\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Deploy for production\\n\\n\", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# on指定了该workflow的触发时机\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 这里是指定在main分支有更新时触发（直接push或者merge进main分支都会触发该时间）\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"push\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"branches\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" main\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"jobs\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# job id\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"production\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# runs-on指定了运行任务的机器类型，值得一提的是，我们可以使用自己的机器（比如需要支持内网环境），更多可以去了解“self-hosted runner”\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"runs-on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" ubuntu\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"latest\\n    \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# environment指的就是仓库设置中 Actions secrets and variables 对应的environment，用于区分变量环境\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"environment\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" production\\n\\n    \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# steps就是每个job具体的步骤\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"steps\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# uses代表了这里使用了一个社区贡献的action\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# checkout到指定分支\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" actions/checkout@v3\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"ref\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" main\\n\\n      \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 指定node版本\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" actions/setup\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"node@v3\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"node-version\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token number\",\n          children: \"16\"\n        }), \"\\n\\n      \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# yarn install\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" borales/actions\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"yarn@v4\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" yarn install\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"cmd\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" install\\n\\n      \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# yarn export\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" borales/actions\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"yarn@v4\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" yarn export\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"cmd\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" export\\n\\n      \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 将上一步的构建目录推动到指定仓库的指定分支\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Pushes to the blog github pages\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" cpina/github\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"action\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"push\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"to\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"another\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"repository@main\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# secrets在仓库settings中进行设置好，在对应的环境便可读取\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"API_TOKEN_GITHUB\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" $\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" secrets.API_TOKEN_GITHUB \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"source-directory\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'docs'\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"destination-github-username\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'B-sirius'\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"destination-repository-name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'b-sirius.github.io'\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"target-branch\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" main\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"有了这样一个自动触发的工作流后，我便拆分出了博客源代码仓库。每次源代码仓库的main分支更新时，Github Actions会自动去进行构建，并将构建结果push到Github Pages使用的仓库\", _jsx(_components.a, {\n        href: \"https://github.com/B-sirius/b-sirius.github.io\",\n        children: \"b-sirius.github.io\"\n      }), \"的main分支。而Github Pages也会在main更新时，自动触发部署，更新线上页面。于是我之前提到的痛点的前两个，就都解决了。\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"cloudflare-pages\",\n      children: \"CloudFlare Pages\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"于是我还剩下一个问题：如何支持测试（preview）环境？对于任何应用来说，在本地验证与生产环境发布之间，至少还需要在测试环境验证一次。Github Pages目前还没有对preview环境的官方支持（尽管应该是在\", _jsx(_components.a, {\n        href: \"https://github.com/community/community/discussions/7730\",\n        children: \"进展之中\"\n      }), \"），所以我个人选择了一个简单的方案：再使用一家pages服务，如CloudFlare Pages、Vercel。他们二者都与Git有很好的集成，以下将以CloudFlare Pages为例。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"注册登录关联git仓库这些都没什么好说的，都是固定流程，在这些绑定完成后，我们就需要去做一些具体的设置了。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"默认情况下，CloudFlare Pages会为main分支自动部署production环境，对所有其余分支自动部署preview环境，后者正好就满足了我们的需要，而前者我不需要，于是将其设置将其关闭。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/02/14/HVPWFqh7Gwstz1J.png\",\n        alt: \"分支部署\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在构建设置中，其实只要指定构建命令与用于上传的构建目录，这部分的配置自然上面的github workflow其实是一模一样的。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/02/14/ZantFJBoziTp5XS.png\",\n        alt: \"构建设置\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"有一个小细节是，在github workflow中我们指定了node版本，CloudFlare Pages也支持这一点，通过环境变量的方式，你可以在这里看到更多支持的\", _jsx(_components.a, {\n        href: \"https://developers.cloudflare.com/pages/platform/build-configuration/#environment-variables\",\n        children: \"环境变量\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/02/14/oxYwl26eGp8daWS.png\",\n        alt: \"指定node版本\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"总结\",\n      children: \"总结\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"于是，我们就实现了这样一个简单却实用的CI/CD流水线。可以看出：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"Github Actions其实是一个非常灵活的hook工具，可以去自定义触发各种各样有趣的任务（类似的服务还有Amazon Lambda）；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Github Pages是一个纯粹的静态站点托管服务，上传静态站点，它就呈现；\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"CloudFlare Pages和Vercel也是静态站点托管服务，但是它们更加注重与其他平台的集成，并通过低码的方式去完成简单的构建部署以及呈现；\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"最终，整个博客部署的步骤如下，只有虚线的关键卡点步骤是手动操作，而其余的工作都会自动完成，很方便吧。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/02/14/iljSW7nucVfgAF1.png\",\n        alt: \"优化博客部署.png\"\n      })\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"description":"我个人的首选方案是Github Pages，因为它免费，且域名直观。......","usedCustomComponentNames":[]},"__N_SSG":true}