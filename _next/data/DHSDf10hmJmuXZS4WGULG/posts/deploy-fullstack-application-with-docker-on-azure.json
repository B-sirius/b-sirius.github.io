{"pageProps":{"id":"deploy-fullstack-application-with-docker-on-azure","title":"从Dev到DevOps，借助Docker在Azure上部署你的第一个全栈应用","date":"2024-05-24","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h2: \"h2\",\n    p: \"p\",\n    img: \"img\",\n    strong: \"strong\",\n    a: \"a\",\n    ul: \"ul\",\n    li: \"li\",\n    h3: \"h3\",\n    ol: \"ol\",\n    code: \"code\",\n    pre: \"pre\",\n    span: \"span\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h2, {\n      id: \"简介\",\n      children: \"简介\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"作为开发者，我们都已经很熟悉本地开发环境了，但如何将一个本地应用部署到线上，或许还是触及到了你的一些知识盲区。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/16/ge3lIN4HRYBDQUL.png\",\n        alt: \"本地一切爽，线上火葬场\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"本文将一步步的带你部署一个包含独立前后端的完整应用到\", _jsx(_components.strong, {\n        children: \"Azure\"\n      }), \"，希望可以帮助你理解部署应用到线上的大致思路。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"本文所涉及的应用以及workflow的源代码：\", _jsx(_components.a, {\n        href: \"https://github.com/B-sirius/fullstack-demo\",\n        children: \"fullstack-demo\"\n      })]\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"主角登场\",\n      children: \"主角登场\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在开始之前，介绍一下本文的主角们：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"应用构成\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"前端：React\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"后端：Nodejs\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"ORM：Prisma\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"数据库：PostgresQL\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"代码托管：Github\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"CICD：Github Actions\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"容器技术：Docker\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"容器镜像托管：Docker Hub\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"反向代理：Nginx\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"云服务：Azure\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"App Service\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"数据库服务：Azure Database for PostgreSQL flexible server\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"好，停一下，看到这里其实不难看出此次教程的大致思路，让我拉一张图给你感受一下：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/16/RkLaJhfApr6giOF.png\",\n        alt: \"pipeline最终效果\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以看出，我们的pipeline以容器技术为核心，如果你对docker一类的容器技术还不熟悉，建议先去自行了解下。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"另外，该流程绝非线上部署的\", _jsx(_components.strong, {\n        children: \"最佳实践\"\n      }), \"，只是提供一种基于容器的部署思路，且该流程也缺乏很多production环境应该考虑的部分，还请大家仅作学习参考。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"最后，如果你不熟悉以上的某个具体的服务，也不要紧，因为其中任何一块都可以被其他类似的服务替代。比如：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"Azure => AWS\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Docker Hub => Azure Container Registry\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Github => Gitlab\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"好，我们接下来就开始一步步的实现上面的部署流程！\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"分析一下本次要部署的web应用\",\n      children: \"分析一下本次要部署的Web应用\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在想着如何部署线上之前，我们先要对应用有一个大致的了解：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"由哪些服务构成\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"这些服务在本地是如何启动的\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"确保能够在本地将应用完整的运行起来\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"本次要部署的应用是一个BBS，用户可以在上面完成发帖，顶帖，踩贴这样非常基础的功能。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这个应用由三部分组成：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"React搭建的客户端\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Nodejs搭建的服务端\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"postgres数据库服务，服务端将使用Prisma与其交互\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"是非常典型的前后端分离应用。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"客户端\",\n      children: \"客户端\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们先看客户端的部分，它有以下特征：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"使用webpack构建的React应用\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"构建产物为纯静态资源\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"它本地启动的方式，在\", _jsx(_components.code, {\n        children: \"package.json\"\n      }), \"中可以看到：\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-json\",\n      children: _jsxs(_components.code, {\n        className: \"language-json\",\n        children: [_jsx(_components.span, {\n          className: \"token property\",\n          children: \"\\\"start\\\"\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"webpack-dev-server --mode development\\\"\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.code, {\n        children: \"webpack-dev-server\"\n      }), \"从名字就可以看出是用于本地开发的服务，虽然我们不会在线上使用它，但是有必要看看它的相关配置，于是我们就点开了\", _jsx(_components.code, {\n        children: \"webpack.config.ts\"\n      }), \"，寻找其中的\", _jsx(_components.code, {\n        children: \"devServer\"\n      }), \"字段：\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-javascript\",\n      children: _jsxs(_components.code, {\n        className: \"language-javascript\",\n        children: [_jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"devServer\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"port\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token number\",\n          children: \"3000\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"historyApiFallback\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token boolean\",\n          children: \"true\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"proxy\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token string-property property\",\n          children: \"\\\"/api\\\"\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"target\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"http://localhost:3000\\\"\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"token function-variable function\",\n          children: \"router\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=>\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"http://localhost:8000\\\"\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// remove path\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"pathRewrite\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string-property property\",\n          children: \"\\\"^/api\\\"\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"\\\"\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这里有两个重要信息，在本地开发时：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"客户端应用会被暴露在localhost:3000\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"webpack的反向代理功能做了两件事：\", \"\\n\", _jsxs(_components.ol, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"将/api来源的请求指向了localhost:8000\"\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"重写了path，路径中的\", _jsx(_components.code, {\n              children: \"/api\"\n            }), \"部分被移除了\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"不难猜测，8000端口暴露的就是我们本地的服务端应用。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"所以客户端在本地是这样工作的：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/17/nzPAakJ6RDcHdNu.png\",\n        alt: \"客户端的运作方式\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"服务端\",\n      children: \"服务端\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"服务端是一个Node.js应用，更准去的说是Nest.js应用（一个基于Node.js的框架），我们看下它在本地是如何启动的：\"\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-json\",\n      children: _jsxs(_components.code, {\n        className: \"language-JSON\",\n        children: [_jsx(_components.span, {\n          className: \"token property\",\n          children: \"\\\"start\\\"\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"nest start\\\"\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"不是很有营养，既然这里没有额外的参数，那我们就看看Nestjs的入口文件\", _jsx(_components.code, {\n        children: \"main.ts\"\n      }), \"：\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-typescript\",\n      children: _jsxs(_components.code, {\n        className: \"language-typescript\",\n        children: [_jsx(_components.span, {\n          className: \"token keyword control-flow\",\n          children: \"await\"\n        }), \" app\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token method function property-access\",\n          children: \"listen\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token number\",\n          children: \"8000\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"所以服务端是在本地8000端口运行的，符合我们上面的推测。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"数据库\",\n      children: \"数据库\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"最后我们看一下数据库，数据库的启动非常简单，我们可以在\", _jsx(_components.code, {\n        children: \"docker-compose\"\n      }), \"中看到，这里使用了postgres官方镜像，并传入了一些必要的参数用于本地启动。可以看出数据库服务启动在5432端口。\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-yaml\",\n      children: _jsxs(_components.code, {\n        className: \"language-yaml\",\n        children: [_jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# Postgres container\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"postgres\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"image\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" postgres\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), _jsx(_components.span, {\n          className: \"token number\",\n          children: \"15\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"restart\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" always\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"environment\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" POSTGRES_USER=myuser\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" POSTGRES_PASSWORD=mypassword\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"volumes\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" postgres\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"/var/lib/postgresql/data\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"ports\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'5432:5432'\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"在本地将所有的服务跑起来\",\n      children: \"在本地将所有的服务跑起来\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"除了上述的命令外，我们还需要额外做两件事：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"设置环境变量\", _jsx(_components.code, {\n            children: \"DATABASE_URL\"\n          })]\n        }), \"，让服务端能够访问数据库\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"使用Prisma Migrate数据库\"\n        }), \"，否则本地数据库将无法同步我们的服务端将要访问的database，tables等等\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"完整的步骤可以参考示例代码的\", _jsx(_components.a, {\n        href: \"https://github.com/B-sirius/fullstack-demo?tab=readme-ov-file#local-setup\",\n        children: \"README\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"总结\",\n      children: \"总结\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们的应用在本地是如此运行的，其实并不复杂：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/20/nBX6bf9zOekjELF.png\",\n        alt: \"how-client-works-full.png\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"将一切搬到线上\",\n      children: \"将一切搬到线上\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/16/RkLaJhfApr6giOF.png\",\n        alt: \"pipeline最终效果\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"让我们再次回顾一下这张图，将代码同步到Github想必不会难倒你，那剩下要做的事情大致还有这么几件：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"准备各个服务的docker image\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"准备workflow\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"构建各服务的docker image并推送到docker hub\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"从docker hub拉取image并部署到Azure\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"配置Azure相关的App services等\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"1-准备docker-image\",\n      children: \"1. 准备docker image\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这部分就不过多叙述了，因为如何为你的服务编写dockerfile可以说是一个case by case的事，这里可以参考我的dockerfile，相信并不难理解。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"总的来说我们只需要分别准备客户端和服务端的docker image，而线上数据库服务我们将会直接使用Azure的\", _jsx(_components.code, {\n        children: \"Azure Database for PostgreSQL flexible server\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-dockerfile\",\n      children: _jsxs(_components.code, {\n        className: \"language-dockerfile\",\n        children: [_jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 以client的dockerfile为例\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# stage 1 - build react app first\"\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"FROM\"\n          }), \" node:18 \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"AS\"\n          }), \" build\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"WORKDIR\"\n          }), \" /app\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"COPY\"\n          }), \" package.json yarn.lock ./\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"RUN\"\n          }), \" yarn install --frozen-lockfile\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"COPY\"\n          }), \" . .\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"RUN\"\n          }), \" yarn build\"]\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# stage 2 - serve the react app on nginx\"\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"FROM\"\n          }), \" nginx:latest\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"USER\"\n          }), \" root\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"COPY\"\n          }), \" \", _jsxs(_components.span, {\n            className: \"token options\",\n            children: [_jsx(_components.span, {\n              className: \"token property\",\n              children: \"--from\"\n            }), _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \"=\"\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \"build\"\n            })]\n          }), \" /app/build /usr/share/nginx/html\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"EXPOSE\"\n          }), \" 80\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"token instruction\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"CMD\"\n          }), \" [\", _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"nginx\\\"\"\n          }), \", \", _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"-g\\\"\"\n          }), \", \", _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"daemon off;\\\"\"\n          }), \"]\"]\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"2-新增workflow将image推送到docker-hub\",\n      children: \"2. 新增workflow，将image推送到docker hub\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"现在我们开始准备workflow，首先我们先构建docker image，并将它们上传到docker hub：\"\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-yml\",\n      children: _jsxs(_components.code, {\n        className: \"language-yml\",\n        children: [_jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 以构建并上传client image为例\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Build and Push Client Docker Image\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"push\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"branches\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" dev\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"paths\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"client/**\\\"\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# Monitor changes in the client folder\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"workflow_dispatch\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"jobs\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"build\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"runs-on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" ubuntu\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"latest\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"environment\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" dev\\n\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"steps\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Login to DockerHub\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" docker/login\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"action@v3\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"username\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" $\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" secrets.DOCKERHUB_USERNAME \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"password\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" $\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" secrets.DOCKERHUB_ACCESS_TOKEN \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Publish Docker image to Docker Hub\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" docker/build\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"push\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"action@v5\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"context\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"{{defaultContext}}:client\\\"\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# the path where dockerfile located\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"push\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token boolean important\",\n          children: \"true\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"tags\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"${{ vars.CLIENT_IMAGE }}:latest\\\"\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这里用到了两个docker官方action，具体使用方法可以参考它们的文档\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://github.com/docker/login-action/tree/v3\",\n          children: \"docker/login-action\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://github.com/docker/build-push-action/tree/v5\",\n          children: \"docker/build-push-action\"\n        })\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果workflow可以成功跑起来，你应该能在docker hub中看见自己的image\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/21/1ug4it7wcMIzXvU.png\",\n        alt: \"docker images\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"3-新增azure的数据库\",\n      children: \"3. 新增Azure的数据库\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在继续进行之前，我们先把线上的数据库准备好。这里我选用了Azure官方的\", _jsx(_components.code, {\n        children: \"Azure Database for PostgreSQL server\"\n      }), \"。需要注意数据库是会\", _jsx(_components.strong, {\n        children: \"产生费用的\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"数据库创建时，验证手段我选用了仅PostgreSQL验证（PostgreSQL authentication only），请记住你的username和password。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在创建成功后，你的数据库应该有一个独特的Server Name为：\", _jsx(_components.code, {\n        children: \"<your-database-name>.postgres.database.azure.com\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/21/eQ3cCwyqozVYPXK.png\",\n        alt: \"postgreSQL serviec\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"另外你应该去\", _jsx(_components.code, {\n        children: \"Networking\"\n      }), \"中为数据库设置防火墙规则，仅允许你当前的客户端ip访问。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/21/HwMEkDC6r75eG9o.png\",\n        alt: \"firewall rule\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"数据库准备好后，你可以尝试用pgAdmin一类的工具去连接它，确保配置没有问题。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"4-配置azure的app-services\",\n      children: \"4. 配置Azure的App Services\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"数据库准备好后。让我们分别为客户端和服务端创建App Services。如何创建一个App Service这里也不做赘述，注意以下几点：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"创建一个\", _jsx(_components.code, {\n          children: \"Web App\"\n        })]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"可以先随便部署一个默认镜像（比如Nginx）\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"每个app service都会有一个\", _jsx(_components.code, {\n        children: \"default domain\"\n      }), \"，格式为\", _jsx(_components.code, {\n        children: \"<your-web-app-name>.azurewebsites.net\"\n      }), \"，这个地址默认是可以在公网访问的。我现在分别为客户端和服务端创建了app service：\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/21/Ya7ORDTrQgMijAP.png\",\n        alt: \"app services\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"5-设置必要的环境变量\",\n      children: \"5. 设置必要的环境变量\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"还记得我们在本地启动服务端应用的时候，服务端用到了一个环境变量么\", _jsx(_components.code, {\n        children: \"DATABASE_URL\"\n      }), \"？这个环境变量告诉服务端，Prisma如何连接数据库。在本地的时候，环境变量的值是：\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        children: \"DATABASE_URL=\\\"postgresql://myuser:mypassword@localhost:5432/mydb?schema=public\\\"\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这个值的结构是：\", _jsx(_components.code, {\n        children: \"postgresql://<username>:<password>@<server-domain>:<server-port>/<database-name>?schema=public\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"假设我们的Azure Database的信息是这样：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"Server Name：test.postgres.database.azure.com\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"账号：testuser\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"密码：HolyPostgres9876\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"那线上的\", _jsx(_components.code, {\n        children: \"DATABASE_URL\"\n      }), \"就是\", _jsx(_components.code, {\n        children: \"postgresql://testuser:HolyPostgres9876@test.postgres.database.azure.com:5432/mydb?schema=public\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"那么在哪里设置这个值呢？由于这个值现在是服务端的App Service运行container所需要的，我们应该去对应的App Service的\", _jsx(_components.code, {\n        children: \"Environment variables\"\n      }), \"去设置它：\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/22/BnUcxqrh2WYOXNT.png\",\n        alt: \"Environment variables\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"6-新增workflow让azure拉取我们的docker-image并进行部署\",\n      children: \"6. 新增workflow，让Azure拉取我们的docker image并进行部署\"\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-yml\",\n      children: _jsxs(_components.code, {\n        className: \"language-yml\",\n        children: [_jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 以部署client image为例\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Deploy Client Image to Azure App Service\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"workflow_dispatch\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"jobs\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"deploy\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"runs-on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" ubuntu\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"latest\\n\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"steps\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Deploy to Azure Web App\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"id\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" deploy\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"to\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"webapp\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" azure/webapps\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"deploy@v2\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"app-name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"test-fullstack-client\\\"\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"slot-name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"production\\\"\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"publish-profile\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" $\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" secrets.AZURE_CLIENT_PUBLISH_PROFILE \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"images\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"index.docker.io/${{ vars.CLIENT_IMAGE }}:latest\\\"\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这里用到了一个Azure的官方action：(Azure/webapps-deploy)[https://github.com/Azure/webapps-deploy/tree/v2]，可以直接把对应的image部署到你指定的azure app service。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"试着运行下你的workflow，如果成功的话，刷新Azure后你应该能看到\", _jsx(_components.code, {\n        children: \"Container Image\"\n      }), \"变为了你自己的Image：\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/21/8swD7kLSUcWhqu4.png\",\n        alt: \"container image updated\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"7-migrate-azure数据库\",\n      children: \"7. Migrate Azure数据库\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"对于线上数据库，我们同样也需要Migrate。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在本地运行项目的时候，我们运行了\", _jsx(_components.code, {\n        children: \"yarn migrate\"\n      }), \"，它实际上调用了\", _jsx(_components.code, {\n        children: \"npx prisma migrate dev\"\n      }), \"，prisma会读取本地的\", _jsx(_components.code, {\n        children: \".env\"\n      }), \"，连接到本地数据库，并进行migrate。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"尽管我们这不能算一个production案例，但总的来说还是不推荐使用这种方式去操作线上数据库。因此依照\", _jsx(_components.a, {\n        href: \"https://www.prisma.io/docs/orm/prisma-client/deployment/deploy-database-changes-with-prisma-migrate\",\n        children: \"Prisma文档\"\n      }), \"的建议，我们可以在Deploy Service Image的时候去Migrate线上数据库：\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-yml\",\n      children: _jsxs(_components.code, {\n        className: \"language-yml\",\n        children: [_jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Deploy Server Image to Azure App Service\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"workflow_dispatch\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"jobs\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"deploy\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"runs-on\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" ubuntu\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"latest\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"environment\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" dev\\n\\n    \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"steps\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Checkout repo\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" actions/checkout@v4\\n\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Setup Node\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" actions/setup\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"node@v4\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"node-version\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'18'\"\n        }), \"\\n\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Install Dependencies\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"working-directory\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" ./server\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"run\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" yarn\\n\\n\\t\\t\\t\", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# 重点在这里！\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Apply all pending migrations to the database\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"working-directory\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" ./server\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"run\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" npx prisma migrate deploy\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"DATABASE_URL\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" $\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" secrets.DATABASE_URL \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" Deploy to Azure Web App\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"id\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" deploy\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"to\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"webapp\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"uses\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" azure/webapps\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"-\"\n        }), \"deploy@v2\\n        \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"with\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"app-name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"test-fullstack-server\\\"\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"slot-name\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"production\\\"\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"publish-profile\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" $\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" secrets.AZURE_SERVER_PUBLISH_PROFILE \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n          \", _jsx(_components.span, {\n          className: \"token key atrule\",\n          children: \"images\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"\\\"index.docker.io/${{ vars.SERVER_IMAGE }}:latest\\\"\"\n        }), \"\\n\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"现在我们在部署服务端镜像时，数据库结构也能保持更新。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"8-验证客户端与服务端的状态\",\n      children: \"8. 验证客户端与服务端的状态\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"此时我们可以分别访问客户端与服务端的默认域名。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"客户端域名此时应该可以加载出页面，尽管请求都404——非常合理，因为请求目前都没有命中到后端服务：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/22/TmcA8yVxHfqoUgG.png\",\n        alt: \"request 404\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而服务端域名此时应该可以返回一些接口响应了：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/22/RQmLkVydwxEOoez.png\",\n        alt: \"server\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"9-配置nginx\",\n      children: \"9. 配置Nginx\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在本地开发时，我们使用了Webpack Dev Server提供的proxy能力，连接起了前后端。能够做到类似事情的常见服务还有一个，那就是Nginx！\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"那么如何在线上运行这样一个Nginx服务？聪明的你一定想到了，再打一个镜像不就行了！\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们先依葫芦画瓢新建一个App Service供Nginx使用，Default Domain为\", _jsx(_components.code, {\n        children: \"test-fullstack.azurewebsites.net\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"然后在代码新建一个nginx配置文件：\"\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-nginx\",\n      children: _jsxs(_components.code, {\n        className: \"language-nginx\",\n        children: [_jsx(_components.span, {\n          className: \"token comment\",\n          children: \"# nginx.conf\"\n        }), \"\\n\\n\", _jsx(_components.span, {\n          className: \"token directive\",\n          children: _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"events\"\n          })\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token directive\",\n          children: _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"http\"\n          })\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token directive\",\n          children: _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"server\"\n          })\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    \", _jsxs(_components.span, {\n          className: \"token directive\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"server_name\"\n          }), \" <your-nginx-app-service-name>.azurewebsites.net\"]\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\\n    \", _jsxs(_components.span, {\n          className: \"token directive\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"location\"\n          }), \" /\"]\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n      \", _jsxs(_components.span, {\n          className: \"token directive\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"proxy_pass\"\n          }), \" <your-client-app-service-name>.azurewebsites.net\"]\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n    \", _jsxs(_components.span, {\n          className: \"token directive\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"location\"\n          }), \" /api\"]\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n      \", _jsxs(_components.span, {\n          className: \"token directive\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"rewrite\"\n          }), \" /api/(.*) /\", _jsx(_components.span, {\n            className: \"token variable\",\n            children: \"$1\"\n          }), \"  break\"]\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n      \", _jsxs(_components.span, {\n          className: \"token directive\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"proxy_pass\"\n          }), \" <your-server-app-service-name>.azurewebsites.net\"]\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"一目了然，我们的nginx服务会分别将路由指向对应的服务，和webpack-dev-server的proxy作用几乎一模一样。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"接下来我们只要仿照前面的步骤去将这个镜像构建并推送到docker hub，并进行部署。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这一步完成后，直接访问你的Nginx的Default Domain，我们的服务应该就可以正常在线上运行了！\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/24/fGhBPDpskeIX3jC.png\",\n        alt: \"线上成功运行\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"10-线上架构\",\n      children: \"10. 线上架构\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"现在我们可以看一下这个应用的线上架构，其实非常简单，而且与本地服务结构类似：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/24/QvESPtTRUKLAbdh.png\",\n        alt: \"客户端线上架构\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"总结提升\",\n      children: \"总结&提升\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"本文的方案非常的单纯，核心就是把本地应用都分别镜像化，然后部署到线上而已。但我们目前的应用有一个显然的问题：客户端服务的域名和服务端服务的域名都是可以在公网被访问的！考虑到我们希望使用Nginx服务作为公网流量的入口，将客户端和服务端的域名限制在内网才更为合理。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"要做到这一点，我们可以请出两个关键的服务：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"Applicatoin Gateway\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Virtual networks\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通过将前后端服务限制在Virtual Networks中，并通过Application Gateway访问，可以让我们的服务更加安全。而且显然Application Gateway还提供了许多其他功能（负载均衡、自动扩容等等）。只不过它有点贵，我小试了一下一天将近50块（货币单位为日元）：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2024/05/22/AjYx8kU7aGHMemf.png\",\n        alt: \"应用网关费用\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"但如果你对这部分内容感兴趣，可以看看这个油管视频：\", _jsx(_components.a, {\n        href: \"https://www.youtube.com/watch?v=1HG_TKG468w\",\n        children: \"App Service Application Gateway Configuration\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"最后，本文作者在云服务方面完完全全是个新手，如果你阅读本文后发现有错误或者可以优化的地方，欢迎指正，感谢🙏\"\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"description":"本地应用如何部署线上，docker如何帮你解放双手，云服务究竟长作什样，本文带你一探究竟！","usedCustomComponentNames":[]},"__N_SSG":true}