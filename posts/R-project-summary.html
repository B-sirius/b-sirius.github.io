<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>LWDW!</title><meta name="description" content="R项目小结"/><meta property="og:title" content="R项目小结"/><meta property="og:description" content="最近结束的一个项目有很多值得学习的地方，挑一些不敏感的在此记录。其中的每一点其实都有深入挖掘的空间，日后想必会再次遇到。......"/><meta name="next-head-count" content="6"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#ffffff"/><meta name="color-scheme" content="dark light"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="theme-color" content="#000"/><meta property="og:type" content="website"/><meta property="og:image" content="https://s2.loli.net/2023/01/18/42YTZxzePtR7jy9.png"/><meta property="og:url" content="https://b-sirius.github.io"/><link rel="preload" href="/_next/static/css/aef510c8abf24c2c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/aef510c8abf24c2c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b51a0fb142b75fa0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b51a0fb142b75fa0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-165611dbf69200d4.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-673a4fae4a27af6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0da236044dc4e5fc.js" defer=""></script><script src="/_next/static/chunks/664-1b4479b4462ded63.js" defer=""></script><script src="/_next/static/chunks/332-e879213584d084bf.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-bdcbd70cb4cfba17.js" defer=""></script><script src="/_next/static/_ClwSS3-Ivr8G5PbtsguX/_buildManifest.js" defer=""></script><script src="/_next/static/_ClwSS3-Ivr8G5PbtsguX/_ssgManifest.js" defer=""></script><style data-styled="" data-styled-version="5.3.6">.hkJmkj{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;border:1px solid var(--dialog-border-color);background-color:var(--dialog-bg-color);padding:1px;}/*!sc*/
.hkJmkj > div{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100%;border:1px solid #9d701d;color:#fff;padding:10px;}/*!sc*/
data-styled.g1[id="sc-87e76b53-0"]{content:"hkJmkj,"}/*!sc*/
.dxfnCq{font-size:22px;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;}/*!sc*/
.dxfnCq > div{width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;}/*!sc*/
data-styled.g2[id="sc-77cf2bd4-0"]{content:"dxfnCq,"}/*!sc*/
.gPcDhw{--root-bg-color:#000;--dialog-bg-color:#262427;--dialog-border-color:#9d701d;--font-color:#fff;--font-highlight-color:#e7e496;--nav-color:#e76464;--blog-title-shadow:1px 1px 2px #ad0909,0 0 1em #7b3f0c,0 0 0.15em #d2ff8f;--blog-hint-shadow:1px 1px 2px #ad0909,0 0 2em #7b3f0c,0 0 0.2em #d2ff8f;background-color:var(--root-bg-color);overflow:scroll;font-family:'GillSans','Helvetica Neue',Arial,Helvetica,sans-serif;}/*!sc*/
data-styled.g3[id="sc-9d615c10-0"]{content:"gPcDhw,"}/*!sc*/
.hptnUW{max-width:960px;margin:auto;overflow:hidden;padding:40px 20px;min-height:100vh;color:var(--font-color);}/*!sc*/
data-styled.g4[id="sc-868660b6-0"]{content:"hptnUW,"}/*!sc*/
.cEuFcK{font-family:monospace;}/*!sc*/
data-styled.g5[id="sc-f71203c5-0"]{content:"cEuFcK,"}/*!sc*/
.BdBtZ{font-size:44px;margin-bottom:0;text-shadow:var(--blog-title-shadow);}/*!sc*/
data-styled.g6[id="sc-f71203c5-1"]{content:"BdBtZ,"}/*!sc*/
.gXENPI{font-size:12px;margin:0;text-shadow:var(--blog-hint-shadow);}/*!sc*/
data-styled.g7[id="sc-f71203c5-2"]{content:"gXENPI,"}/*!sc*/
.dSoHmK{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:20px;}/*!sc*/
data-styled.g8[id="sc-bbc62a17-0"]{content:"dSoHmK,"}/*!sc*/
.bGsVUC{margin-bottom:50px;}/*!sc*/
data-styled.g9[id="sc-bbc62a17-1"]{content:"bGsVUC,"}/*!sc*/
.gGxkic{padding:5px 0;font-family:monospace;color:var(--font-color);font-size:20px;margin-right:20px;}/*!sc*/
.gGxkic:hover{cursor:pointer;}/*!sc*/
@media only screen and (max-width:500px){.gGxkic{font-size:18px;margin-right:10px;}}/*!sc*/
data-styled.g10[id="sc-bbc62a17-2"]{content:"gGxkic,"}/*!sc*/
.bMRVsR{padding:5px 0;font-family:monospace;color:var(--font-color);font-size:20px;margin-right:20px;}/*!sc*/
.bMRVsR:hover{cursor:pointer;}/*!sc*/
@media only screen and (max-width:500px){.bMRVsR{font-size:18px;margin-right:10px;}}/*!sc*/
data-styled.g11[id="sc-bbc62a17-3"]{content:"bMRVsR,"}/*!sc*/
.czeavQ{--md-link-color:#e64f4f;--md-title-shadow:1px 1px 2px #ad0909,0 0 1em #7b3f0c,0 0 0.2em #d2ff8f;--md-title-color:#f2f2f2;--md-sub-title-color:#d3dae1;}/*!sc*/
.czeavQ h2{font-size:30px;margin-top:50px;margin-bottom:0;text-shadow:var(--md-title-shadow);color:var(--md-title-color);}/*!sc*/
.czeavQ h3{font-size:26px;margin-bottom:0;color:var(--md-sub-title-color);}/*!sc*/
.czeavQ h4,.czeavQ h5,.czeavQ h6{font-size:24px;color:var(--md-sub-title-color);}/*!sc*/
.czeavQ p,.czeavQ li{margin-bottom:2em;}/*!sc*/
.czeavQ p,.czeavQ li,.czeavQ a{font-size:18px;line-height:32px;}/*!sc*/
.czeavQ a{color:var(--md-link-color);}/*!sc*/
.czeavQ img{max-width:100%;}/*!sc*/
.czeavQ hr{border-color:#111;}/*!sc*/
.czeavQ blockquote{border-left:5px solid rgb(52,57,59);background-color:rgb(54,0,0);margin:0;padding:1em 1.5em 1em 2em;}/*!sc*/
.czeavQ blockquote p,.czeavQ blockquote li{margin:0;}/*!sc*/
.czeavQ code{font-size:16.5px;background-color:rgba(115,125,140,0.17);padding:4.5px 6px;border-radius:3px;}/*!sc*/
.czeavQ pre code{background-color:transparent;padding:0;border-radius:none;}/*!sc*/
@media only screen and (max-width:500px){.czeavQ p,.czeavQ li,.czeavQ a{font-size:16px;line-height:30px;}.czeavQ code{font-size:14px;}}/*!sc*/
data-styled.g12[id="sc-e9ca5221-0"]{content:"czeavQ,"}/*!sc*/
.fiBoCN{margin-top:50px;}/*!sc*/
data-styled.g13[id="sc-3304c032-0"]{content:"fiBoCN,"}/*!sc*/
.hOKWax{padding:0px 20px 10px;}/*!sc*/
@media only screen and (max-width:500px){.hOKWax{padding:0 5px 10px;}}/*!sc*/
data-styled.g14[id="sc-ba46d312-0"]{content:"hOKWax,"}/*!sc*/
.dmDrcr{padding:20px 20px;}/*!sc*/
@media only screen and (max-width:500px){.dmDrcr{padding:5px 5px;}}/*!sc*/
data-styled.g15[id="sc-ba46d312-1"]{content:"dmDrcr,"}/*!sc*/
.ibvPNw{font-size:40px;color:var(--font-highlight-color);margin-bottom:5px;}/*!sc*/
data-styled.g16[id="sc-ba46d312-2"]{content:"ibvPNw,"}/*!sc*/
.hcdRzS{font-family:monospace;font-size:14px;}/*!sc*/
data-styled.g17[id="sc-ba46d312-3"]{content:"hcdRzS,"}/*!sc*/
</style></head><body><div id="__next"><div class="sc-9d615c10-0 gPcDhw"><div class="sc-868660b6-0 hptnUW"><div class="sc-bbc62a17-1 bGsVUC"><div class="sc-bbc62a17-0 dSoHmK"><a class="sc-bbc62a17-2 gGxkic" href="/">[<!-- -->Home<!-- -->]</a><a class="sc-bbc62a17-2 gGxkic" href="/posts">[<!-- -->Posts<!-- -->]</a><a class="sc-bbc62a17-3 bMRVsR" rel="noopener noreferrer" target="_blank" href="https://github.com/B-sirius">[<!-- -->Github<!-- -->]</a><a class="sc-bbc62a17-3 bMRVsR" rel="noopener noreferrer" target="_blank" href="https://b-sirius.github.io/rss.xml">[<!-- -->RSS<!-- -->]</a></div><div class="sc-f71203c5-0 cEuFcK"><h1 class="sc-f71203c5-1 BdBtZ">LWDW!</h1><p class="sc-f71203c5-2 gXENPI">Learn the work from doing the work🍺</p></div></div><div class="sc-87e76b53-0 sc-77cf2bd4-0 hkJmkj dxfnCq"><div><div class="sc-ba46d312-0 hOKWax"><div class="sc-ba46d312-2 ibvPNw">R项目小结</div><div class="sc-ba46d312-3 hcdRzS">Posted on <!-- -->2023-01-09</div></div></div></div><div class="sc-87e76b53-0 hkJmkj"><div><div class="sc-ba46d312-1 dmDrcr"><div class="sc-e9ca5221-0 czeavQ"><p>最近结束的一个项目有很多值得学习的地方，挑一些不敏感的在此记录。其中的每一点其实都有深入挖掘的空间，日后想必会再次遇到。</p>
<hr/>
<h2 id="文档设计">文档设计</h2>
<p>有哪些文档可以整理归总？有的文档适合单独总结，有的适合放在Readme中，但总之，以下是一些可以考虑的点。</p>
<h3 id="系统设计文档">系统设计文档</h3>
<p>这里的设计指的是系统的架构，尤其要关注<strong>系统之间是如何连接的</strong>。</p>
<p>而以下内容不应该被包含在其中：</p>
<ul>
<li>服务的具体细节。</li>
<li>组件的设计模式。</li>
</ul>
<h3 id="组件文档">组件文档</h3>
<p>整理所有的组件/服务，可以有以下关注点：</p>
<ul>
<li>介绍</li>
<li>服务类型（比如SSR /Static）</li>
<li>路由前缀</li>
<li>生产环境域名</li>
<li>预发环境域名</li>
<li>测试环境域名（规则）</li>
<li>仓库地址</li>
<li>流水线地址</li>
<li>发布分支</li>
<li>涉及技术栈</li>
</ul>
<h3 id="开发者faq">开发者FAQ</h3>
<p>目的是收集开发者关心的常见问题，比如项目如何本地启动，必要权限如何申请等。</p>
<h3 id="开发者验证指南">开发者验证指南</h3>
<p>目的是保证开发者提交的组件可以在生产环境中运行，而不是完全依赖QA。常见的手段有测试用例，code review等，且很可能与CI/CD流程有关。个人觉得开发者很容易对一些小改动有迷之自信，结果却提交无法在测试环境运行的代码甚至搞崩线上。该步骤非常重要又容易被忽视。</p>
<h2 id="aws服务">AWS服务</h2>
<p>aws服务太常见了，稍微记录一下我本次接触的，不至于一些名词都没有概念。</p>
<h3 id="ecs">ECS</h3>
<p>ECS is Amazon Elastic <strong>Container Service</strong>.</p>
<ul>
<li>Container Orchestration Service (容器编排工具）</li>
<li>Manages the whole container lifecycle.<!-- -->
<ul>
<li>start</li>
<li>re-schedule</li>
<li>load balance</li>
</ul>
</li>
<li>ECS Cluster（ECS集群）是Control Plane，管理所有运行着容器的虚拟机器。</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/09/u8ytTRfvmx7gk4n.jpg" alt="How does ECS work"/></p>
<ul>
<li>而这些虚拟机是什么？是EC2 Instance，你还是需要管理这些Instance的，比如在增加container的时候，需要确保Instance的资源足够。</li>
<li>但如果我们想在AWS上hosting infrastructure。可以用AWS Fargate。那就不需要手动管理Instance，他会根据你想要运行的container来自动分配资源。节省呀！</li>
</ul>
<h3 id="eks">EKS</h3>
<p>EKS is Elastic <strong>Kubernetes</strong> Service.</p>
<p>Kubernetes 是ECS的竞品，非常Popular，所以EKS就是为了在AWS使用Kubernetes推出的。</p>
<p>EKS的工作方式和ECS差不多。</p>
<h3 id="ecr">ECR</h3>
<p>ECR is Elastic <strong>Container Registry</strong>, a private docker registry.</p>
<p><img src="https://s2.loli.net/2023/01/09/Lw6m7geKZ9A4YSW.png" alt="whole story, Jenkins involved here!"/></p>
<h3 id="elb">ELB</h3>
<p>ELB is Elastic load balancing service.</p>
<p><img src="https://s2.loli.net/2023/01/09/EaFjZvJ731LDGRA.png" alt="负载均衡服务"/></p>
<p>使用这样一个 load balancer有很多好处</p>
<ul>
<li>将流量分配给了很多下级实例</li>
<li>只暴露出一个入口（DNS）</li>
<li>无缝处理下级应用的failures</li>
<li>对实例进行健康检查</li>
<li>提供https</li>
<li>强制使用cookies，所以用户可以访问到同一个instance</li>
<li>…</li>
</ul>
<h3 id="aws-lambda">AWS lambda</h3>
<p>这是一个Serverless服务，基本上可以理解为它提供了根据事件自动触发Function的能力。</p>
<p>其中事件可以指的是S3的内容变化，API的请求，或其他各种各样的AWS服务事件。</p>
<p>这里涉及到一个概念，Serverless，值得说一说。</p>
<p>我个人的理解是这样的：</p>
<p>首先Serverless并不是说没有Server，而是Server对用户不可见，which means：</p>
<ul>
<li>不需要手动管理server。</li>
<li>会根据使用自动扩容。</li>
<li>只有当被使用的时候，才会产生费用（而不是为Server本身付费）。</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/09/B2oTW3lrEuznZGK.png" alt=""/></p>
<h2 id="环境变量">环境变量</h2>
<h3 id="环境变量-in-nextjs">环境变量 in Next.js</h3>
<p>Before <code>const HOST_NAME = &#x27;www.sample.com&#x27;</code>.</p>
<p>After <code>const HOST_NAME = &#x27;process.env.NEXT_PUBLIC_HOST_NAME&#x27;</code>.</p>
<p>这里涉及到Next.js的一个特性：<a href="https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser" target="_blank" rel="noreferrer">expose env vars to the browser</a>。</p>
<ul>
<li>During the <strong>build stage</strong>, next.js will find these env vars start with <strong>NEXT_PUBLIC_</strong> and replace them with literal.</li>
<li>build stage很关键，在CI/CD流程中，可能有build、release等多个环节，在哪里传入环境变量很关键。</li>
</ul>
<p><strong>Trick: 如果在一些情形下，我们需要把用于node端的环境变量暴露给浏览器，可以怎么做？</strong></p>
<ul>
<li>Read these env vars inside <code>getServerSideProps</code> and return them as props. <a href="https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props#when-does-getserversideprops-run" target="_blank" rel="noreferrer">More to read about it</a>.</li>
</ul>
<pre class="language-javascript"><code class="language-javascript">  <span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getServerSideProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// we can read server side env vars here.</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">serverConstants</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token constant">TEST_HOST_NAME</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">TEST_HOST_NAME</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// client side.</span>
  <span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Page</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> serverConstants <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token constant">TEST_HOST_NAME</span><span class="token operator">:</span> <span class="token punctuation">{</span>serverConstants<span class="token punctuation">.</span><span class="token constant">TEST_HOST_NAME</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
<h3 id="本地环境变量">本地环境变量</h3>
<p>关于在本地开发中使用环境变量，next.js 已经有了很好的支持，查看 <a href="https://nextjs.org/docs/basic-features/environment-variables#loading-environment-variables" target="_blank" rel="noreferrer">这里</a>。</p>
<p>在实际场景下，可以创建一个.env.local.examlpe文件。</p>
<p>开发者可以拷贝该文件并将其作为自己的.env.local文件。</p>
<p><strong>.env.local 不应该被提交到repo中！</strong></p>
<h3 id="环境变量-in-jest">环境变量 in Jest</h3>
<p>方法是有很多的，按需采用，这里记录两种。</p>
<h3 id="在jest的setup文件中设置环境变量">在jest的setup文件中设置环境变量</h3>
<p><a href="https://jestjs.io/docs/configuration#setupfilesafterenv-array" target="_blank" rel="noreferrer">文档在此</a>。简单来说，在这里设置的环境变量会作用于每个测试用例文件。</p>
<p>适合用于设置默认环境变量，但无法满足需要测试不同的环境变量的场景。</p>
<h3 id="在测试用例文件中设置环境变量">在测试用例文件中设置环境变量</h3>
<p>当然我们可以在测试用例文件中设置环境变量。</p>
<p>只是要记住，在每个测试用例前，一定要使用 <a href="https://jestjs.io/docs/jest-object#jestresetmodules" target="_blank" rel="noreferrer"><strong>restModules</strong></a> ，且<strong>动态引入</strong>涉及环境变量的模块。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;environmental variables&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">OLD_ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token method function property-access">resetModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Most important - it clears the cache</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span><span class="token constant">OLD_ENV</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Make a copy</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span> <span class="token operator">=</span> <span class="token constant">OLD_ENV</span><span class="token punctuation">;</span> <span class="token comment">// Restore old environment</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;will receive process.env variables&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set the variables</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">&#x27;dev&#x27;</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">PROXY_PREFIX</span> <span class="token operator">=</span> <span class="token string">&#x27;/new-prefix/&#x27;</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">API_URL</span> <span class="token operator">=</span> <span class="token string">&#x27;https://new-api.com/&#x27;</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">APP_PORT</span> <span class="token operator">=</span> <span class="token string">&#x27;7080&#x27;</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">USE_PROXY</span> <span class="token operator">=</span> <span class="token string">&#x27;false&#x27;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> testedModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../../config/env&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token comment">// dynamic import</span>

    <span class="token comment">// ... actual testing</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="其他">其他</h2>
<h3 id="本地一切安好线上发布缺少依赖可能是">本地一切安好，线上发布缺少依赖，可能是？</h3>
<p>规则：如果<code>NODE_ENV</code>被设置成<code>production</code>，yarn不会安装<code>devDependencies</code>中的依赖，具体可看<a href="https://classic.yarnpkg.com/en/docs/cli/install#toc-yarn-install-production-true-false" target="_blank" rel="noreferrer">这里</a>。</p>
<p>所以这种cmd是合理的：<code>yarn install &amp;&amp; yarn test &amp;&amp; NODE_ENV=production yarn export</code>。</p>
<p>相对的，如果<code>NODE_ENV</code>被设置的太早，很可能会导致<code>yarn test</code>缺少依赖。</p>
<h3 id="如何更新包组件服务">如何更新包/组件/服务</h3>
<p>除了更新逻辑，一般还有哪些步骤？</p>
<ol>
<li>更新测试用例，保证本地测试用例通过。</li>
<li>本地成功运行服务。</li>
<li>开一个draft PR.<!-- -->
<ol>
<li>将其部署到测试环境。</li>
<li>在测试环境成功运行。</li>
</ol>
</li>
<li>更新版本。（视具体情形）</li>
<li>找人review。</li>
<li>有了approvals，可以merge。</li>
<li>其余的就是QA、部署流程等。</li>
</ol>
<h3 id="jwt">JWT</h3>
<p>JWT（JSON web token）是一种常见的在客户端与服务端间传递信息的方式。</p>
<ol>
<li>除非知道签名，用户是无法伪造数据的。</li>
<li>而header和payload本身是并没有被加密的。</li>
</ol>
<p>所以在实际应用场景中，任何人都可以查看请求的数据，但不知道签名的普通用户没办法自己构造、篡改请求。</p>
<p><a href="https://en.wikipedia.org/wiki/JSON_Web_Token" target="_blank" rel="noreferrer">进一步了解JWT</a>。</p>
<h3 id="yarn2">Yarn2</h3>
<p>Yarn2 = <strong>yarn berry</strong>（更加准确）。和 yarn 1.x 比起来算是大改。</p>
<p>如果使用PnP特性，yarn会生成<code>.pnp.cjs</code>以代替<code>node_modules</code>。</p>
<p><code>.pnp.cjs</code>只是一些maps，包括如何在文件系统中找到packages。</p>
<p>而packages本身，是被zipped压缩过的，所以文件的数量远远少于<code>node_modules</code>。</p>
<p>尽管package被压缩过，我们仍然可以借助<code>fs</code>的能力读取文件。</p>
<p><strong>更多yarn2，欢迎阅读：</strong></p>
<ul>
<li><a href="https://blog.logrocket.com/javascript-package-managers-compared/" target="_blank" rel="noreferrer">JavaScript package managers compared: npm, Yarn, or pnpm?</a></li>
<li><a href="https://www.yarnpkg.cn/features/pnp" target="_blank" rel="noreferrer">Plug&#x27;n&#x27;Play</a></li>
</ul>
<h3 id="线上监控服务异常排查">线上监控服务异常排查</h3>
<p>如果怀疑有异常的线上流量，如何排查：</p>
<ol>
<li>调整时间区间，来观察流量是否是一瞬间涌入的。</li>
<li>比较服务端和客户端的流量，观察流量是否是直接打到服务端的。</li>
<li>比较流量峰值日志是否有共同点：Client IP, Country, Region, City…</li>
</ol></div></div></div></div><div class="sc-3304c032-0 fiBoCN"><div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"R-project-summary","title":"R项目小结","date":"2023-01-09","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    hr: \"hr\",\n    h2: \"h2\",\n    h3: \"h3\",\n    strong: \"strong\",\n    ul: \"ul\",\n    li: \"li\",\n    img: \"img\",\n    code: \"code\",\n    a: \"a\",\n    pre: \"pre\",\n    span: \"span\",\n    ol: \"ol\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: \"最近结束的一个项目有很多值得学习的地方，挑一些不敏感的在此记录。其中的每一点其实都有深入挖掘的空间，日后想必会再次遇到。\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      id: \"文档设计\",\n      children: \"文档设计\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"有哪些文档可以整理归总？有的文档适合单独总结，有的适合放在Readme中，但总之，以下是一些可以考虑的点。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"系统设计文档\",\n      children: \"系统设计文档\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这里的设计指的是系统的架构，尤其要关注\", _jsx(_components.strong, {\n        children: \"系统之间是如何连接的\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而以下内容不应该被包含在其中：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"服务的具体细节。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"组件的设计模式。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"组件文档\",\n      children: \"组件文档\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"整理所有的组件/服务，可以有以下关注点：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"介绍\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"服务类型（比如SSR /Static）\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"路由前缀\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"生产环境域名\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"预发环境域名\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"测试环境域名（规则）\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"仓库地址\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"流水线地址\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"发布分支\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"涉及技术栈\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"开发者faq\",\n      children: \"开发者FAQ\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"目的是收集开发者关心的常见问题，比如项目如何本地启动，必要权限如何申请等。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"开发者验证指南\",\n      children: \"开发者验证指南\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"目的是保证开发者提交的组件可以在生产环境中运行，而不是完全依赖QA。常见的手段有测试用例，code review等，且很可能与CI/CD流程有关。个人觉得开发者很容易对一些小改动有迷之自信，结果却提交无法在测试环境运行的代码甚至搞崩线上。该步骤非常重要又容易被忽视。\"\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"aws服务\",\n      children: \"AWS服务\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"aws服务太常见了，稍微记录一下我本次接触的，不至于一些名词都没有概念。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"ecs\",\n      children: \"ECS\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ECS is Amazon Elastic \", _jsx(_components.strong, {\n        children: \"Container Service\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"Container Orchestration Service (容器编排工具）\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Manages the whole container lifecycle.\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"start\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"re-schedule\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"load balance\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"ECS Cluster（ECS集群）是Control Plane，管理所有运行着容器的虚拟机器。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/01/09/u8ytTRfvmx7gk4n.jpg\",\n        alt: \"How does ECS work\"\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"而这些虚拟机是什么？是EC2 Instance，你还是需要管理这些Instance的，比如在增加container的时候，需要确保Instance的资源足够。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"但如果我们想在AWS上hosting infrastructure。可以用AWS Fargate。那就不需要手动管理Instance，他会根据你想要运行的container来自动分配资源。节省呀！\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"eks\",\n      children: \"EKS\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"EKS is Elastic \", _jsx(_components.strong, {\n        children: \"Kubernetes\"\n      }), \" Service.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Kubernetes 是ECS的竞品，非常Popular，所以EKS就是为了在AWS使用Kubernetes推出的。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"EKS的工作方式和ECS差不多。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"ecr\",\n      children: \"ECR\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"ECR is Elastic \", _jsx(_components.strong, {\n        children: \"Container Registry\"\n      }), \", a private docker registry.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/01/09/Lw6m7geKZ9A4YSW.png\",\n        alt: \"whole story, Jenkins involved here!\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"elb\",\n      children: \"ELB\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"ELB is Elastic load balancing service.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/01/09/EaFjZvJ731LDGRA.png\",\n        alt: \"负载均衡服务\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"使用这样一个 load balancer有很多好处\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"将流量分配给了很多下级实例\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"只暴露出一个入口（DNS）\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"无缝处理下级应用的failures\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"对实例进行健康检查\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"提供https\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"强制使用cookies，所以用户可以访问到同一个instance\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"…\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"aws-lambda\",\n      children: \"AWS lambda\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这是一个Serverless服务，基本上可以理解为它提供了根据事件自动触发Function的能力。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其中事件可以指的是S3的内容变化，API的请求，或其他各种各样的AWS服务事件。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这里涉及到一个概念，Serverless，值得说一说。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我个人的理解是这样的：\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"首先Serverless并不是说没有Server，而是Server对用户不可见，which means：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"不需要手动管理server。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"会根据使用自动扩容。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"只有当被使用的时候，才会产生费用（而不是为Server本身付费）。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"https://s2.loli.net/2023/01/09/B2oTW3lrEuznZGK.png\",\n        alt: \"\"\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"环境变量\",\n      children: \"环境变量\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"环境变量-in-nextjs\",\n      children: \"环境变量 in Next.js\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Before \", _jsx(_components.code, {\n        children: \"const HOST_NAME = 'www.sample.com'\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"After \", _jsx(_components.code, {\n        children: \"const HOST_NAME = 'process.env.NEXT_PUBLIC_HOST_NAME'\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这里涉及到Next.js的一个特性：\", _jsx(_components.a, {\n        href: \"https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser\",\n        children: \"expose env vars to the browser\"\n      }), \"。\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"During the \", _jsx(_components.strong, {\n          children: \"build stage\"\n        }), \", next.js will find these env vars start with \", _jsx(_components.strong, {\n          children: \"NEXT_PUBLIC_\"\n        }), \" and replace them with literal.\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"build stage很关键，在CI/CD流程中，可能有build、release等多个环节，在哪里传入环境变量很关键。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.strong, {\n        children: \"Trick: 如果在一些情形下，我们需要把用于node端的环境变量暴露给浏览器，可以怎么做？\"\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"Read these env vars inside \", _jsx(_components.code, {\n          children: \"getServerSideProps\"\n        }), \" and return them as props. \", _jsx(_components.a, {\n          href: \"https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props#when-does-getserversideprops-run\",\n          children: \"More to read about it\"\n        }), \".\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-javascript\",\n      children: _jsxs(_components.code, {\n        className: \"language-javascript\",\n        children: [\"  \", _jsx(_components.span, {\n          className: \"token keyword module\",\n          children: \"export\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token function-variable function\",\n          children: \"getServerSideProps\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// we can read server side env vars here.\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token keyword control-flow\",\n          children: \"return\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token literal-property property\",\n          children: \"serverConstants\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"TEST_HOST_NAME\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"TEST_HOST_NAME\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n  \\n  \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// client side.\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token keyword module\",\n          children: \"export\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token function-variable function\",\n          children: _jsx(_components.span, {\n            className: \"token maybe-class-name\",\n            children: \"Page\"\n          })\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token parameter\",\n          children: \"props\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" serverConstants \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" props\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token keyword control-flow\",\n          children: \"return\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"\u003c\"\n        }), \"p\", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"\u003e\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"TEST_HOST_NAME\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"serverConstants\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"TEST_HOST_NAME\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"\u003c\"\n        }), _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"/\"\n        }), \"p\", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"\u003e\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"本地环境变量\",\n      children: \"本地环境变量\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"关于在本地开发中使用环境变量，next.js 已经有了很好的支持，查看 \", _jsx(_components.a, {\n        href: \"https://nextjs.org/docs/basic-features/environment-variables#loading-environment-variables\",\n        children: \"这里\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在实际场景下，可以创建一个.env.local.examlpe文件。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"开发者可以拷贝该文件并将其作为自己的.env.local文件。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.strong, {\n        children: \".env.local 不应该被提交到repo中！\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"环境变量-in-jest\",\n      children: \"环境变量 in Jest\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"方法是有很多的，按需采用，这里记录两种。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"在jest的setup文件中设置环境变量\",\n      children: \"在jest的setup文件中设置环境变量\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.a, {\n        href: \"https://jestjs.io/docs/configuration#setupfilesafterenv-array\",\n        children: \"文档在此\"\n      }), \"。简单来说，在这里设置的环境变量会作用于每个测试用例文件。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"适合用于设置默认环境变量，但无法满足需要测试不同的环境变量的场景。\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"在测试用例文件中设置环境变量\",\n      children: \"在测试用例文件中设置环境变量\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"当然我们可以在测试用例文件中设置环境变量。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"只是要记住，在每个测试用例前，一定要使用 \", _jsx(_components.a, {\n        href: \"https://jestjs.io/docs/jest-object#jestresetmodules\",\n        children: _jsx(_components.strong, {\n          children: \"restModules\"\n        })\n      }), \" ，且\", _jsx(_components.strong, {\n        children: \"动态引入\"\n      }), \"涉及环境变量的模块。\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      className: \"language-javascript\",\n      children: _jsxs(_components.code, {\n        className: \"language-javascript\",\n        children: [_jsx(_components.span, {\n          className: \"token function\",\n          children: \"describe\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'environmental variables'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"OLD_ENV\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\\n  \", _jsx(_components.span, {\n          className: \"token function\",\n          children: \"beforeEach\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    jest\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token method function property-access\",\n          children: \"resetModules\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// Most important - it clears the cache\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token spread operator\",\n          children: \"...\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"OLD_ENV\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// Make a copy\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\\n  \", _jsx(_components.span, {\n          className: \"token function\",\n          children: \"afterAll\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"OLD_ENV\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// Restore old environment\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\\n  \", _jsx(_components.span, {\n          className: \"token function\",\n          children: \"test\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'will receive process.env variables'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \",\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token arrow operator\",\n          children: \"=\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"{\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// Set the variables\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"NODE_ENV\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'dev'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"PROXY_PREFIX\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'/new-prefix/'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"API_URL\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'https://new-api.com/'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"APP_PORT\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'7080'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n    process\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token property-access\",\n          children: \"env\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token constant\",\n          children: \"USE_PROXY\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'false'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\\n    \", _jsx(_components.span, {\n          className: \"token keyword\",\n          children: \"const\"\n        }), \" testedModule \", _jsx(_components.span, {\n          className: \"token operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token function\",\n          children: \"require\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"(\"\n        }), _jsx(_components.span, {\n          className: \"token string\",\n          children: \"'../../config/env'\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \".\"\n        }), _jsx(_components.span, {\n          className: \"token keyword module\",\n          children: \"default\"\n        }), \" \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// dynamic import\"\n        }), \"\\n\\n    \", _jsx(_components.span, {\n          className: \"token comment\",\n          children: \"// ... actual testing\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \"}\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \")\"\n        }), _jsx(_components.span, {\n          className: \"token punctuation\",\n          children: \";\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      id: \"其他\",\n      children: \"其他\"\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"本地一切安好线上发布缺少依赖可能是\",\n      children: \"本地一切安好，线上发布缺少依赖，可能是？\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"规则：如果\", _jsx(_components.code, {\n        children: \"NODE_ENV\"\n      }), \"被设置成\", _jsx(_components.code, {\n        children: \"production\"\n      }), \"，yarn不会安装\", _jsx(_components.code, {\n        children: \"devDependencies\"\n      }), \"中的依赖，具体可看\", _jsx(_components.a, {\n        href: \"https://classic.yarnpkg.com/en/docs/cli/install#toc-yarn-install-production-true-false\",\n        children: \"这里\"\n      }), \"。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"所以这种cmd是合理的：\", _jsx(_components.code, {\n        children: \"yarn install \u0026\u0026 yarn test \u0026\u0026 NODE_ENV=production yarn export\"\n      }), \"。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"相对的，如果\", _jsx(_components.code, {\n        children: \"NODE_ENV\"\n      }), \"被设置的太早，很可能会导致\", _jsx(_components.code, {\n        children: \"yarn test\"\n      }), \"缺少依赖。\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"如何更新包组件服务\",\n      children: \"如何更新包/组件/服务\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"除了更新逻辑，一般还有哪些步骤？\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"更新测试用例，保证本地测试用例通过。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"本地成功运行服务。\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"开一个draft PR.\", \"\\n\", _jsxs(_components.ol, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"将其部署到测试环境。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"在测试环境成功运行。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"更新版本。（视具体情形）\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"找人review。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"有了approvals，可以merge。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"其余的就是QA、部署流程等。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"jwt\",\n      children: \"JWT\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"JWT（JSON web token）是一种常见的在客户端与服务端间传递信息的方式。\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"除非知道签名，用户是无法伪造数据的。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"而header和payload本身是并没有被加密的。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"所以在实际应用场景中，任何人都可以查看请求的数据，但不知道签名的普通用户没办法自己构造、篡改请求。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.a, {\n        href: \"https://en.wikipedia.org/wiki/JSON_Web_Token\",\n        children: \"进一步了解JWT\"\n      }), \"。\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"yarn2\",\n      children: \"Yarn2\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Yarn2 = \", _jsx(_components.strong, {\n        children: \"yarn berry\"\n      }), \"（更加准确）。和 yarn 1.x 比起来算是大改。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"如果使用PnP特性，yarn会生成\", _jsx(_components.code, {\n        children: \".pnp.cjs\"\n      }), \"以代替\", _jsx(_components.code, {\n        children: \"node_modules\"\n      }), \"。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.code, {\n        children: \".pnp.cjs\"\n      }), \"只是一些maps，包括如何在文件系统中找到packages。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"而packages本身，是被zipped压缩过的，所以文件的数量远远少于\", _jsx(_components.code, {\n        children: \"node_modules\"\n      }), \"。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"尽管package被压缩过，我们仍然可以借助\", _jsx(_components.code, {\n        children: \"fs\"\n      }), \"的能力读取文件。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.strong, {\n        children: \"更多yarn2，欢迎阅读：\"\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://blog.logrocket.com/javascript-package-managers-compared/\",\n          children: \"JavaScript package managers compared: npm, Yarn, or pnpm?\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://www.yarnpkg.cn/features/pnp\",\n          children: \"Plug'n'Play\"\n        })\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      id: \"线上监控服务异常排查\",\n      children: \"线上监控服务异常排查\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果怀疑有异常的线上流量，如何排查：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"调整时间区间，来观察流量是否是一瞬间涌入的。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"比较服务端和客户端的流量，观察流量是否是直接打到服务端的。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"比较流量峰值日志是否有共同点：Client IP, Country, Region, City…\"\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"description":"最近结束的一个项目有很多值得学习的地方，挑一些不敏感的在此记录。其中的每一点其实都有深入挖掘的空间，日后想必会再次遇到。......","usedCustomComponentNames":[]},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"R-project-summary"},"buildId":"_ClwSS3-Ivr8G5PbtsguX","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>