<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>LWDW!</title><meta name="description" content="弹一弹#1 碰撞检测效率与四叉树"/><meta property="og:title" content="弹一弹#1 碰撞检测效率与四叉树"/><meta property="og:description" content="最近微信弹一弹游戏突然火了，俺又正好在学习相关知识，就来蹭波热点开个系列，拆分一下弹一弹游戏可能涉及到的各种算法或数据结构的实现。当然，估计这个系列更完的时候弹一弹也该凉了嗯。......"/><meta name="next-head-count" content="6"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#ffffff"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="theme-color" content="#000"/><meta property="og:type" content="website"/><meta property="og:image" content="https://s2.loli.net/2023/01/18/42YTZxzePtR7jy9.png"/><meta property="og:url" content="https://b-sirius.github.io"/><link rel="preload" href="/_next/static/css/aef510c8abf24c2c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/aef510c8abf24c2c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b51a0fb142b75fa0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b51a0fb142b75fa0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-f164db4954bac6ec.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-673a4fae4a27af6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0da236044dc4e5fc.js" defer=""></script><script src="/_next/static/chunks/664-1b4479b4462ded63.js" defer=""></script><script src="/_next/static/chunks/332-e879213584d084bf.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-ca2b821b98344017.js" defer=""></script><script src="/_next/static/8iFDsdjaTfV5KLx0s_qSu/_buildManifest.js" defer=""></script><script src="/_next/static/8iFDsdjaTfV5KLx0s_qSu/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="sc-590e23a2-0 iUjvom"><div class="sc-7fa12c98-0 iqAzDm"><div class="sc-357ac6e1-1 blSmbb"><div class="sc-357ac6e1-0 fqUBXX"><a class="sc-357ac6e1-2 gfNIvm" href="/">[<!-- -->Home<!-- -->]</a><a class="sc-357ac6e1-2 gfNIvm" href="/posts">[<!-- -->Posts<!-- -->]</a><a class="sc-357ac6e1-3 eNeEmH" rel="noopener noreferrer" target="_blank" href="https://github.com/B-sirius">[<!-- -->Github<!-- -->]</a><a class="sc-357ac6e1-3 eNeEmH" rel="noopener noreferrer" target="_blank" href="https://b-sirius.github.io/rss.xml">[<!-- -->RSS<!-- -->]</a></div><div class="sc-f5ce872-0 drvesR"><h1 class="sc-f5ce872-1 jPBPjm">LWDW!</h1><p class="sc-f5ce872-2 djaGsH">Learn the work from doing the work🍺</p></div></div><div class="sc-920e94b6-0 sc-659069c1-0 cMfBpD jHWfVM"><div><div class="sc-32c5999b-0 iFBmZi"><div class="sc-32c5999b-2 fHkOeB">弹一弹#1 碰撞检测效率与四叉树</div><div class="sc-32c5999b-3 deKveP">Posted on <!-- -->2018-04-26</div></div></div></div><div class="sc-920e94b6-0 cMfBpD"><div><div class="sc-32c5999b-1 fNXLto"><div class="sc-ba7d3cad-0 gyeaXD"><div><html><head></head><body><h2 id="前言">前言</h2>
<p>最近微信弹一弹游戏突然火了，俺又正好在学习相关知识，就来蹭波热点开个系列，拆分一下弹一弹游戏可能涉及到的各种算法或数据结构的实现。当然，估计这个系列更完的时候弹一弹也该凉了嗯。</p>
<h3 id="在弹之前">在弹之前</h3>
<p>弹一弹，是一个典型的以碰撞、反弹为核心玩法的游戏。在每一帧计算时，首先要考虑的问题就是涉及的元素是否发生了碰撞，因此也就产生了碰撞检测以及其检测效率的问题，咱先用最耿直的方法来解决这个问题。</p>
<h3 id="两个物体的检测">两个物体的检测</h3>
<p>这还不简单，判断两个物体的碰撞无非是通过各自的x, y位置和宽高等属性计算出两者有无交集。在游戏进行的每一帧中，我们只要计算第一个物体是否碰到了第二个物体。</p>
<h3 id="n个物体的检测">n个物体的检测</h3>
<p>emmmm，由于需要确认他们是否互相碰撞，因此需要一个双重for循环嘛，外层代表这是检测的第n个物体，内层表示他是否与其他的n-1个物体发生碰撞。显然，对于每一帧的检测，时间复杂度是 <strong>O(n^2)</strong> ；如果我们做一个2d的海洋球池，里面有2000个球，则每帧约需要做4000000次碰撞计算——对于理想的60帧应用，一帧的时间大约是16.6ms，李猜一猜来不来得及算呢？</p>
<p>下面是一个仅涉及碰撞检测的demo，无反弹计算，里面有2000个小球，发生碰撞的球会高亮显示，为了照顾您的cpu，只有点了“开始”按钮后才会开始运算。结论是俺个人的小mac pro跑这个demo约为13帧，对于2帧流畅5帧丝滑的玩家可以说是很厉害了嗯！</p>
<p data-height="265" data-theme-id="0" data-slug-hash="GdZVeo" data-default-tab="js,result" data-user="padfoot_07" data-embed-version="2" data-pen-title="Silly-ImpactChecking" class="codepen">See the Pen <a href="https://codepen.io/padfoot_07/pen/GdZVeo/" target="_blank" rel="nofollow">Silly-ImpactChecking</a> by Zhouyi (<a href="https://codepen.io/padfoot_07" target="_blank" rel="nofollow">@padfoot_07</a>) on <a href="https://codepen.io" target="_blank" rel="nofollow">CodePen</a>.</p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>
<h2 id="引入四叉树">引入四叉树</h2>
<p>气不气？明眼人都明白，你说左下角和右上角的物体离那么远，有必要去进行检查么？是否有办法，让每个点只需要去<strong>检查他附近的一片区域</strong>，而不是盲目的去对整片地图内的物体进行检查。换句话说，我们需要一个方法，能高效的获得一片区域内所有的物体。</p>
<p><img src="https://hukua-blog.oss-cn-beijing.aliyuncs.com/markdown-imgs/quadtree-scan.png" alt="利用四叉树进行区域扫描"></p>
<p>所以上面是一个看上去很浮夸的图像，可以看到绿框内的点全部都被选中并加亮了，线上demo见<a href="https://codepen.io/padfoot_07/pen/PRaojV" target="_blank" rel="nofollow">codepen</a>。</p>
<p>观察上面的图像，大家可以看出似乎点越密集的地方会分裂出越多的小方块，想必其中是有种奇妙的数据结构在做支撑，那就是俺们的主角——<strong>四叉树</strong></p>
<h2 id="wtf-is-quadtree">WTF is Quadtree</h2>
<h3 id="想要实现的策略">想要实现的策略</h3>
<p>在实现四分树前，我们先讲一下往这个平面添加一个个物体的策略，假设容量为4</p>
<p><img src="https://hukua-blog.oss-cn-beijing.aliyuncs.com/markdown-imgs/%E5%9B%9B%E5%88%86%E6%A0%91%E6%B5%81%E7%A8%8B.png" alt="流程"></p>
<p>视觉上的表现大概是这样：</p>
<p><img src="https://hukua-blog.oss-cn-beijing.aliyuncs.com/markdown-imgs/quadtree%E7%AD%96%E7%95%A5.png" alt="quadtree策略"></p>
<h3 id="数据结构的实现">数据结构的实现</h3>
<p>为了实现上面的策略，我们引入了四分树这样的数据结构：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">QuadTree</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">boundary<span class="token punctuation">,</span> capacity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span> <span class="token operator">=</span> boundary<span class="token punctuation">;</span> <span class="token comment">// 该节点的边界，也就是上文的平面</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capacity</span> <span class="token operator">=</span> capacity<span class="token punctuation">;</span> <span class="token comment">// 该节点的容量</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">points</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 放入该节点的物体</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">divided</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 该节点是否发生了分裂</span>
    <span class="token punctuation">}</span>
    <span class="token spread operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当我们试图往其中放入一个物体时：</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token function">insert</span><span class="token punctuation">(</span><span class="token parameter">point</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果物体不在该节点的边界内，直接返回false</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span><span class="token punctuation">.</span><span class="token method function property-access">contain</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果节点容量有剩余，记录该物体</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">points</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&#x3C;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capacity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">points</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 容量已满</span>
        <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 该节点还未分裂，则进行分裂</span>
            <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">divided</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">subdivide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 试图将物体放入分裂出的子节点</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">NW</span><span class="token punctuation">.</span><span class="token method function property-access">insert</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">NE</span><span class="token punctuation">.</span><span class="token method function property-access">insert</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SW</span><span class="token punctuation">.</span><span class="token method function property-access">insert</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SE</span><span class="token punctuation">.</span><span class="token method function property-access">insert</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>上面涉及到了一个重要的操作，节点的分裂：</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token function">subdivide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 边界的相关信息</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> w <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span><span class="token punctuation">.</span><span class="token property-access">w</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> h <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span><span class="token punctuation">.</span><span class="token property-access">h</span><span class="token punctuation">;</span>

        <span class="token comment">// 获得子节点的边界对象，就是被田字分割的四个子区块</span>
        <span class="token keyword">let</span> nw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>x <span class="token operator">-</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">-</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ne <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>x <span class="token operator">+</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">-</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>x <span class="token operator">-</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">+</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> se <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>x <span class="token operator">+</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">+</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获得了四个子节点，并记录了他们的引用</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">NW</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span>nw<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capacity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">NE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span>ne<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capacity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SW</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span>sw<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capacity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span>se<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">capacity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置分裂tag</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">divided</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>到此为止，将一个物体放入平面的操作就抽象完毕了，现在回到我们一开始的问题：如何获得一片区域的所有物体？代码已经很直观的说明了：</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token comment">// 传入一个区域（边界对象）和结果数组（默认为空）</span>
	<span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">range<span class="token punctuation">,</span> found <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果节点的边界和区域边界无交集，不处理</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>range<span class="token punctuation">.</span><span class="token method function property-access">intersect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">boundary</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对于该子节点记录的所有物体，如果该物体在区域边界内，结果数组记录该物体</span>
            <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> p <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">points</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span><span class="token method function property-access">contain</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> found<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 如果这个节点发生了分裂，对其所有子区块递归查询</span>
            <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">divided</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">NW</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> found<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">NE</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> found<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SW</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> found<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SE</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> found<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// 返回结果数组</span>
            <span class="token keyword control-flow">return</span> found<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>至此，放入&#x26;获取的操作便都可以实现了。</p>
<p>那么，想要检查一个物体附近的区域，无非就是以这个物体的坐标、大小为基准创造一个合适的边界作为查询条件，获得他旁边的物体，再进行碰撞的判断。</p>
<h3 id="时间复杂度的考察">时间复杂度的考察</h3>
<p>啊——所以你构建了一个看起来很酷的数据结构，但是它就比双重循环更好嘛？</p>
<p>我们先考虑对1个物体的检测：大家都知道二分查找，由于每一次查找的区域减半，二分查找的时间复杂度为<strong>O(log n)</strong>；同理，对于四分树的查找，查找的区域会不断的缩小为上一次的1/4，时间复杂度也是<strong>O(log n)</strong>；我们最初的问题是对n个物体之间的碰撞检测，所以这个过程要进行n次，所以<strong>借助四分树，查询的时间复杂度降低到了O(n * log n)</strong>！爽到！</p>
<p>下面就是应用了四分树的碰撞查询demo，除了在查询时引入了四分树外，其他的操作和上文那卡爆的demo是完全一样的，在俺的小mac上帧数保持在45-55帧：</p>
<p data-height="265" data-theme-id="0" data-slug-hash="OZyvqM" data-default-tab="js,result" data-user="padfoot_07" data-embed-version="2" data-pen-title="QuadTree-ImpactChecking" class="codepen">See the Pen <a href="https://codepen.io/padfoot_07/pen/OZyvqM/" target="_blank" rel="nofollow">QuadTree-ImpactChecking</a> by Zhouyi (<a href="https://codepen.io/padfoot_07" target="_blank" rel="nofollow">@padfoot_07</a>) on <a href="https://codepen.io" target="_blank" rel="nofollow">CodePen</a>.</p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>
<h2 id="结论">结论</h2>
<p>四分树在这个应用中所做的工作是将每个物体需要去检测的邻居物体的范围从<strong>整个平面</strong>缩小到了我们自己指定的<strong>一小片范围</strong>，虽然构建四分树也需要时间和空间成本，但收益显然是巨大的 d(`･∀･)b</p>
<hr>
<p>下一篇讲什么呢——这一篇讲多个物体碰撞检测的效率，下一篇预定为两个物体间碰撞检测的具体实现吧，感觉好难( º﹃º )</p>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="https://youtu.be/OJxEcs0w_kE" target="_blank" rel="nofollow">Codeing Challenge #98: Quadtree</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%8F%89%E6%A0%91" target="_blank" rel="nofollow">四叉树-维基百科</a></li>
</ol>
</body></html></div></div></div></div></div><div class="sc-bbd5e802-0 cbkQsN"><div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"use-quadtree-in-impact-checking","title":"弹一弹#1 碰撞检测效率与四叉树","date":"2018-04-26","htmlText":"\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003ch2 id=\"前言\"\u003e前言\u003c/h2\u003e\n\u003cp\u003e最近微信弹一弹游戏突然火了，俺又正好在学习相关知识，就来蹭波热点开个系列，拆分一下弹一弹游戏可能涉及到的各种算法或数据结构的实现。当然，估计这个系列更完的时候弹一弹也该凉了嗯。\u003c/p\u003e\n\u003ch3 id=\"在弹之前\"\u003e在弹之前\u003c/h3\u003e\n\u003cp\u003e弹一弹，是一个典型的以碰撞、反弹为核心玩法的游戏。在每一帧计算时，首先要考虑的问题就是涉及的元素是否发生了碰撞，因此也就产生了碰撞检测以及其检测效率的问题，咱先用最耿直的方法来解决这个问题。\u003c/p\u003e\n\u003ch3 id=\"两个物体的检测\"\u003e两个物体的检测\u003c/h3\u003e\n\u003cp\u003e这还不简单，判断两个物体的碰撞无非是通过各自的x, y位置和宽高等属性计算出两者有无交集。在游戏进行的每一帧中，我们只要计算第一个物体是否碰到了第二个物体。\u003c/p\u003e\n\u003ch3 id=\"n个物体的检测\"\u003en个物体的检测\u003c/h3\u003e\n\u003cp\u003eemmmm，由于需要确认他们是否互相碰撞，因此需要一个双重for循环嘛，外层代表这是检测的第n个物体，内层表示他是否与其他的n-1个物体发生碰撞。显然，对于每一帧的检测，时间复杂度是 \u003cstrong\u003eO(n^2)\u003c/strong\u003e ；如果我们做一个2d的海洋球池，里面有2000个球，则每帧约需要做4000000次碰撞计算——对于理想的60帧应用，一帧的时间大约是16.6ms，李猜一猜来不来得及算呢？\u003c/p\u003e\n\u003cp\u003e下面是一个仅涉及碰撞检测的demo，无反弹计算，里面有2000个小球，发生碰撞的球会高亮显示，为了照顾您的cpu，只有点了“开始”按钮后才会开始运算。结论是俺个人的小mac pro跑这个demo约为13帧，对于2帧流畅5帧丝滑的玩家可以说是很厉害了嗯！\u003c/p\u003e\n\u003cp data-height=\"265\" data-theme-id=\"0\" data-slug-hash=\"GdZVeo\" data-default-tab=\"js,result\" data-user=\"padfoot_07\" data-embed-version=\"2\" data-pen-title=\"Silly-ImpactChecking\" class=\"codepen\"\u003eSee the Pen \u003ca href=\"https://codepen.io/padfoot_07/pen/GdZVeo/\" target=\"_blank\" rel=\"nofollow\"\u003eSilly-ImpactChecking\u003c/a\u003e by Zhouyi (\u003ca href=\"https://codepen.io/padfoot_07\" target=\"_blank\" rel=\"nofollow\"\u003e@padfoot_07\u003c/a\u003e) on \u003ca href=\"https://codepen.io\" target=\"_blank\" rel=\"nofollow\"\u003eCodePen\u003c/a\u003e.\u003c/p\u003e\n\u003cscript async src=\"https://static.codepen.io/assets/embed/ei.js\"\u003e\u003c/script\u003e\n\u003ch2 id=\"引入四叉树\"\u003e引入四叉树\u003c/h2\u003e\n\u003cp\u003e气不气？明眼人都明白，你说左下角和右上角的物体离那么远，有必要去进行检查么？是否有办法，让每个点只需要去\u003cstrong\u003e检查他附近的一片区域\u003c/strong\u003e，而不是盲目的去对整片地图内的物体进行检查。换句话说，我们需要一个方法，能高效的获得一片区域内所有的物体。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://hukua-blog.oss-cn-beijing.aliyuncs.com/markdown-imgs/quadtree-scan.png\" alt=\"利用四叉树进行区域扫描\"\u003e\u003c/p\u003e\n\u003cp\u003e所以上面是一个看上去很浮夸的图像，可以看到绿框内的点全部都被选中并加亮了，线上demo见\u003ca href=\"https://codepen.io/padfoot_07/pen/PRaojV\" target=\"_blank\" rel=\"nofollow\"\u003ecodepen\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e观察上面的图像，大家可以看出似乎点越密集的地方会分裂出越多的小方块，想必其中是有种奇妙的数据结构在做支撑，那就是俺们的主角——\u003cstrong\u003e四叉树\u003c/strong\u003e\u003c/p\u003e\n\u003ch2 id=\"wtf-is-quadtree\"\u003eWTF is Quadtree\u003c/h2\u003e\n\u003ch3 id=\"想要实现的策略\"\u003e想要实现的策略\u003c/h3\u003e\n\u003cp\u003e在实现四分树前，我们先讲一下往这个平面添加一个个物体的策略，假设容量为4\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://hukua-blog.oss-cn-beijing.aliyuncs.com/markdown-imgs/%E5%9B%9B%E5%88%86%E6%A0%91%E6%B5%81%E7%A8%8B.png\" alt=\"流程\"\u003e\u003c/p\u003e\n\u003cp\u003e视觉上的表现大概是这样：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://hukua-blog.oss-cn-beijing.aliyuncs.com/markdown-imgs/quadtree%E7%AD%96%E7%95%A5.png\" alt=\"quadtree策略\"\u003e\u003c/p\u003e\n\u003ch3 id=\"数据结构的实现\"\u003e数据结构的实现\u003c/h3\u003e\n\u003cp\u003e为了实现上面的策略，我们引入了四分树这样的数据结构：\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuadTree\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003econstructor\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eboundary\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e capacity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e boundary\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 该节点的边界，也就是上文的平面\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecapacity\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e capacity\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 该节点的容量\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003epoints\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 放入该节点的物体\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edivided\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 该节点是否发生了分裂\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e当我们试图往其中放入一个物体时：\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e    \u003cspan class=\"token function\"\u003einsert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003epoint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 如果物体不在该节点的边界内，直接返回false\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003econtain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epoint\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 如果节点容量有剩余，记录该物体\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003epoints\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003elength\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003epoints\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epoint\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 容量已满\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 该节点还未分裂，则进行分裂\u003c/span\u003e\n            \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edivided\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esubdivide\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 试图将物体放入分裂出的子节点\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNW\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003einsert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epoint\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003einsert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epoint\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSW\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003einsert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epoint\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003einsert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epoint\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e上面涉及到了一个重要的操作，节点的分裂：\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e    \u003cspan class=\"token function\"\u003esubdivide\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 边界的相关信息\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eh\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 获得子节点的边界对象，就是被田字分割的四个子区块\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e nw \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRectangle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e ne \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRectangle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e sw \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRectangle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e se \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRectangle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e w \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 获得了四个子节点，并记录了他们的引用\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNW\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuadTree\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enw\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNE\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuadTree\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ene\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSW\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuadTree\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esw\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSE\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuadTree\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ese\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 设置分裂tag\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edivided\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e到此为止，将一个物体放入平面的操作就抽象完毕了，现在回到我们一开始的问题：如何获得一片区域的所有物体？代码已经很直观的说明了：\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e    \u003cspan class=\"token comment\"\u003e// 传入一个区域（边界对象）和结果数组（默认为空）\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003erange\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e found \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 如果节点的边界和区域边界无交集，不处理\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003erange\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eintersect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eboundary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 对于该子节点记录的所有物体，如果该物体在区域边界内，结果数组记录该物体\u003c/span\u003e\n            \u003cspan class=\"token keyword control-flow\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e p \u003cspan class=\"token keyword\"\u003eof\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003epoints\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erange\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003econtain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ep\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e found\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ep\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"token comment\"\u003e// 如果这个节点发生了分裂，对其所有子区块递归查询\u003c/span\u003e\n            \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edivided\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNW\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erange\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e found\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erange\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e found\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSW\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erange\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e found\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erange\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e found\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \n            \u003cspan class=\"token comment\"\u003e// 返回结果数组\u003c/span\u003e\n            \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e found\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e至此，放入\u0026#x26;获取的操作便都可以实现了。\u003c/p\u003e\n\u003cp\u003e那么，想要检查一个物体附近的区域，无非就是以这个物体的坐标、大小为基准创造一个合适的边界作为查询条件，获得他旁边的物体，再进行碰撞的判断。\u003c/p\u003e\n\u003ch3 id=\"时间复杂度的考察\"\u003e时间复杂度的考察\u003c/h3\u003e\n\u003cp\u003e啊——所以你构建了一个看起来很酷的数据结构，但是它就比双重循环更好嘛？\u003c/p\u003e\n\u003cp\u003e我们先考虑对1个物体的检测：大家都知道二分查找，由于每一次查找的区域减半，二分查找的时间复杂度为\u003cstrong\u003eO(log n)\u003c/strong\u003e；同理，对于四分树的查找，查找的区域会不断的缩小为上一次的1/4，时间复杂度也是\u003cstrong\u003eO(log n)\u003c/strong\u003e；我们最初的问题是对n个物体之间的碰撞检测，所以这个过程要进行n次，所以\u003cstrong\u003e借助四分树，查询的时间复杂度降低到了O(n * log n)\u003c/strong\u003e！爽到！\u003c/p\u003e\n\u003cp\u003e下面就是应用了四分树的碰撞查询demo，除了在查询时引入了四分树外，其他的操作和上文那卡爆的demo是完全一样的，在俺的小mac上帧数保持在45-55帧：\u003c/p\u003e\n\u003cp data-height=\"265\" data-theme-id=\"0\" data-slug-hash=\"OZyvqM\" data-default-tab=\"js,result\" data-user=\"padfoot_07\" data-embed-version=\"2\" data-pen-title=\"QuadTree-ImpactChecking\" class=\"codepen\"\u003eSee the Pen \u003ca href=\"https://codepen.io/padfoot_07/pen/OZyvqM/\" target=\"_blank\" rel=\"nofollow\"\u003eQuadTree-ImpactChecking\u003c/a\u003e by Zhouyi (\u003ca href=\"https://codepen.io/padfoot_07\" target=\"_blank\" rel=\"nofollow\"\u003e@padfoot_07\u003c/a\u003e) on \u003ca href=\"https://codepen.io\" target=\"_blank\" rel=\"nofollow\"\u003eCodePen\u003c/a\u003e.\u003c/p\u003e\n\u003cscript async src=\"https://static.codepen.io/assets/embed/ei.js\"\u003e\u003c/script\u003e\n\u003ch2 id=\"结论\"\u003e结论\u003c/h2\u003e\n\u003cp\u003e四分树在这个应用中所做的工作是将每个物体需要去检测的邻居物体的范围从\u003cstrong\u003e整个平面\u003c/strong\u003e缩小到了我们自己指定的\u003cstrong\u003e一小片范围\u003c/strong\u003e，虽然构建四分树也需要时间和空间成本，但收益显然是巨大的 d(`･∀･)b\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e下一篇讲什么呢——这一篇讲多个物体碰撞检测的效率，下一篇预定为两个物体间碰撞检测的具体实现吧，感觉好难( º﹃º )\u003c/p\u003e\n\u003ch2 id=\"参考资料\"\u003e参考资料\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://youtu.be/OJxEcs0w_kE\" target=\"_blank\" rel=\"nofollow\"\u003eCodeing Challenge #98: Quadtree\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%8F%89%E6%A0%91\" target=\"_blank\" rel=\"nofollow\"\u003e四叉树-维基百科\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/body\u003e\u003c/html\u003e","description":"最近微信弹一弹游戏突然火了，俺又正好在学习相关知识，就来蹭波热点开个系列，拆分一下弹一弹游戏可能涉及到的各种算法或数据结构的实现。当然，估计这个系列更完的时候弹一弹也该凉了嗯。......"},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"use-quadtree-in-impact-checking"},"buildId":"8iFDsdjaTfV5KLx0s_qSu","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>